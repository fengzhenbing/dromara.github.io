<!doctype html><html><head><title>Use MOSN to build Service Mesh platform · dromara(Open source organization)</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="The girl on the prairie"><meta name=generator content="Hugo 0.55.5"><link rel="shortcut icon" href=/img/favicon.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="en"</script><script src=/js/app.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-187960192-2','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link href=/en/><img class=logo src=/img/logo.png></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/en/projects/><span>Projects</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/guides/><span>Guides</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/blog/><span>Blog</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/activities/><span>Activity</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/awesome/><span>Awesome Dromara</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/projects/mosn/quick-start-run-with-sofamesh/><span>中文</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/en/projects/>Projects</a>
<a class=navbar-item href=/en/guides/>Guides</a>
<a class=navbar-item href=/en/blog/>Blog</a>
<a class=navbar-item href=/en/activities/>Activity</a>
<a class=navbar-item href=/awesome/>Awesome Dromara</a></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/projects/mosn/quick-start-run-with-sofamesh/>中</a></div></div></div></nav></header><div class=ss-layout-container><aside class="ss-layout-aside -left ss-card -soft-hidden"></aside><main class="ss-layout-main -card"><div class=ss-meta><div class=container><h1 class=title>Use MOSN to build Service Mesh platform</h1><a class="edit-button -hidden-mobile" href=https://github.com/dromara/edit/master/content/en/projects/mosn/quick-start-run-with-sofamesh/index.md>Edit</a></div><div class=meta>Update time: 2021-01-24</div></div><article class=typo><p>This article introduces how to use MOSN to build the Service Mesh development environment based on SOFAMesh framework, and verify some basic capabilities of MOSN, such as routing and load balancing. This article includes the following content:</p><ul><li>Relationship between MOSN and SOFAMesh</li><li>Preparations</li><li>Deploy SOFAMesh with source codes</li><li>Bookinfo experiment</li></ul><h2 id=relationship-between-mosn-and-sofamesh>Relationship between MOSN and SOFAMesh</h2><p>As mentioned in <a href=../overview>MOSN introduction</a>, MOSN is a Service Mesh data plane agent developed with Golang, and SOFAMesh is a large-scale implementation solution for Service Mesh, which is improved and extended based on Istio. Serving as a critical component of SOFAMesh, MOSN is used to complete data plane forwarding.</p><p>The following figure shows the workflow chart of MOSN based on the overall SOFAMesh framework.</p><p>Note: Currently, MOSN cannot be directly used in the native Istio.</p><p><img src=mosn-with-service-mesh.png width=450 height=400></p><h2 id=preparations>Preparations</h2><p>This guide supposes you are using macOS. For other operating systems, you can install the corresponding software.</p><h3 id=1-install-hyperkit>1. Install HyperKit</h3><p>Install <a href=https://store.docker.com/editions/community/docker-ce-desktop-mac>docker-for-mac</a>, and then <a href=https://github.com/kubernetes/minikube/blob/master/docs/drivers.md>install driver</a>.</p><h4 id=1-1-install-docker>1.1 Install Docker</h4><p>Download the Docker software package to install it or run the following command to install it:</p><pre><code class=language-bash>$ brew cask install docker
</code></pre><h4 id=1-2-install-driver>1.2 Install driver</h4><pre><code class=language-bash>$ curl -LO https://storage.googleapis.com/minikube/releases/latest/docker-machine-driver-hyperkit \
&amp;&amp; chmod +x docker-machine-driver-hyperkit \
&amp;&amp; sudo mv docker-machine-driver-hyperkit /usr/local/bin/ \
&amp;&amp; sudo chown root:wheel /usr/local/bin/docker-machine-driver-hyperkit \
&amp;&amp; sudo chmod u+s /usr/local/bin/docker-machine-driver-hyperkit
</code></pre><h3 id=2-install-minikube-or-purchase-the-commercial-version-of-k8s-cluster>2. Install Minikube (or purchase the commercial version of k8s cluster)</h3><p>It is recommended to use Minikube V0.28 or later, see <a href=https://github.com/kubernetes/minikube>https://github.com/kubernetes/minikube</a>.</p><pre><code class=language-bash>$ brew cask install minikube
</code></pre><h3 id=3-start-minikube>3. Start Minikube</h3><p>Note that Pilot requires at least 2G memory, so you can add resources to Minikube by adding parameters at startup. If your machine has insufficient resources, it is recommended to use the commercial version of the k8s cluster.</p><pre><code class=language-bash>$ minikube start --memory=8192 --cpus=4 --kubernetes-version=v1.15.0 --vm-driver=hyperkit
</code></pre><p>Create Istio namespace</p><pre><code class=language-bash>$ kubectl create namespace istio-system
</code></pre><h3 id=4-install-kubectl-command-line-tool>4. Install kubectl command line tool</h3><p>kubectl is a command line interface used to run commands for k8s cluster. For how to install it, see <a href=https://kubernetes.io/docs/tasks/tools/install-kubectl>https://kubernetes.io/docs/tasks/tools/install-kubectl</a>.</p><pre><code class=language-bash>$ brew install kubernetes-cli
</code></pre><h3 id=5-install-helm>5. Install Helm</h3><p>Helm is a package management tool for k8s. For how to install it, see <a href=https://docs.helm.sh/using_helm/#installing-helm>https://docs.helm.sh/using_helm/#installing-helm</a>.</p><pre><code class=language-bash>$ brew install kubernetes-helm
</code></pre><h2 id=deploy-sofamesh-with-source-codes>Deploy SOFAMesh with source codes</h2><h3 id=1-download-sofamesh-source-codes>1. Download SOFAMesh source codes</h3><pre><code class=language-bash>$ git clone git@github.com:sofastack/sofa-mesh.git
</code></pre><h3 id=2-use-helm-to-install-sofamesh>2. Use Helm to install SOFAMesh</h3><p>You should change directory to sofa-mesh source code, and then use helm template to install isito crd and istio</p><pre><code>```
$ cd sofa-mesh
$ helm template install/kubernetes/helm/istio-init --name istio-init --namespace istio-system | kubectl apply -f -
$ helm template install/kubernetes/helm/istio --name istio --namespace istio-system | kubectl apply -f -
```
</code></pre><p>Uninstall</p><pre><code>```
$ helm template install/kubernetes/helm/istio --name istio --namespace istio-system | kubectl delete -f -
$ kubectl delete namespace istio-system
```    
</code></pre><h3 id=3-verify-installation>3. Verify installation</h3><p>When the pods in the istio-system namespace are Running, it means SOFAMesh has been successfully deployed.
If you just want to run &lsquo;bookinfo&rsquo; example, you only need &lsquo;citadel&rsquo;, &lsquo;pilot&rsquo;, and &lsquo;sidecar-injector&rsquo; are Running.</p><pre><code class=language-bash>$ kubectl get pods -n istio-system
NAME                                       READY    STATUS   RESTARTS    AGE
istio-citadel-6579c78cd9-w57lr              1/1     Running   0          5m
istio-egressgateway-7649f76df4-zs8kw        1/1     Running   0          5m
istio-galley-c77876cb6-nhczq                1/1     Running   0          5m
istio-ingressgateway-5c9c8565d9-d972t       1/1     Running   0          5m
istio-pilot-7485f9fb4b-xsvtm                1/1     Running   0          5m
istio-policy-5766bc84b9-p2wfj               1/1     Running   0          5m
istio-sidecar-injector-7f5f586bc7-2sdx6     1/1     Running   0          5m
istio-statsd-prom-bridge-7f44bb5ddb-stcf6   1/1     Running   0          5m
istio-telemetry-55ff8c77f4-q8d8q            1/1     Running   0          5m
prometheus-84bd4b9796-nq8lg                 1/1     Running   0          5m
</code></pre><h2 id=bookinfo-experiment>BookInfo experiment</h2><p>BookInfo is a book application like Douban. It contains four basic services.</p><ul><li>Product Page: Homepage, which is developed with Python, shows all book information and calls the Reviews and Details services.</li><li>Reviews: Comment, which is developed with Java, shows book reviews and calls the Ratings service.</li><li>Ratings: Rating service, which is developed with Nodejs.</li><li>Details: Book details, which is developed with Ruby.</li></ul><p><img src=bookinfo.png width=550 height=400></p><h3 id=1-deploy-bookinfo-application-and-inject-it-to-mosn>1. Deploy BookInfo application and inject it to MOSN</h3><blockquote><p>For the specific procedure, see <a href=https://istio.io/docs/examples/bookinfo/>https://istio.io/docs/examples/bookinfo/</a>.</p></blockquote><ul><li>Inject to MOSN</li></ul><pre><code class=language-bash>$ kubectl label namespace default istio-injection=enabled
</code></pre><ul><li>Deploy Bookinfo</li></ul><pre><code class=language-bash>$ kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
</code></pre><ul><li>Verify if the deployment is successful</li></ul><pre><code class=language-bash>$ kubectl get services
NAME                       CLUSTER-IP   EXTERNAL-IP   PORT(S)              AGE
details                    10.0.0.31    &lt;none&gt;        9080/TCP             6m
kubernetes                 10.0.0.1     &lt;none&gt;        443/TCP              7d
productpage                10.0.0.120   &lt;none&gt;        9080/TCP             6m
ratings                    10.0.0.15    &lt;none&gt;        9080/TCP             6m
reviews                    10.0.0.170   &lt;none&gt;        9080/TCP             6m
</code></pre><ul><li>Wait till all pods run successfully</li></ul><pre><code class=language-bash>$ kubectl get pods
NAME                                        READY     STATUS    RESTARTS   AGE
details-v1-1520924117-48z17                 2/2       Running   0          6m
productpage-v1-560495357-jk1lz              2/2       Running   0          6m
ratings-v1-734492171-rnr5l                  2/2       Running   0          6m
reviews-v1-874083890-f0qf0                  2/2       Running   0          6m
reviews-v2-1343845940-b34q5                 2/2       Running   0          6m
reviews-v3-1813607990-8ch52                 2/2       Running   0          6m
</code></pre><h3 id=2-access-bookinfo-service>2. Access BookInfo service</h3><ul><li>Enable gateway mode</li></ul><pre><code class=language-bash>$ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml
$ kubectl get gateway        // Check if the gateway runs
NAME               AGE
bookinfo-gateway   24m
</code></pre><ul><li>Set gateway address</li></ul><p>See the details for set gateway address in <a href=https://istio.io/docs/tasks/traffic-management/ingress/ingress-control/#determining-the-ingress-ip-and-ports>https://istio.io/docs/tasks/traffic-management/ingress/ingress-control/#determining-the-ingress-ip-and-ports</a></p><pre><code class=language-bash>$ export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name==&quot;http2&quot;)].nodePort}')
$ export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name==&quot;https&quot;)].nodePort}')
$ export INGRESS_HOST=$(minikube ip)
$ export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT
</code></pre><ul><li>Verify if the gateway takes effect</li></ul><pre><code class=language-bash>$ curl -o /dev/null -s -w &quot;%{http_code}\n&quot;  http://$GATEWAY_URL/productpage   //If 200 is output, it means a success 
200
</code></pre><ul><li>Observe the page status</li></ul><p>Visit http://$GATEWAY_URL/productpage. Note that, you need to replace <code>$GATEWAY_URL</code> with the address you set. Normally, you can see the following BookInfo interface after refreshing the page. There are three versions of Book Reviews. After refreshing, you can see them in turn. To learn why these three versions appear, view the configuration in <code>samples/bookinfo/platform/kube/bookinfo.yaml</code>.</p><ul><li><p>Interface of version 1
<img src=v1.png alt></p></li><li><p>Interface of version 2
<img src=v2.png alt></p></li><li><p>Interface of version 3
<img src=v3.png alt></p></li></ul><h3 id=3-verify-mosn-s-capability-of-routing-by-version>3. Verify MOSN&rsquo;s capability of routing by version</h3><ul><li>Firstly, create a series of destination rules for BookInfo&rsquo;s services.</li></ul><pre><code class=language-bash>$ kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml
</code></pre><ul><li>Specify reviews service to access v1 only.</li></ul><pre><code class=language-bash>$ kubectl apply -f samples/bookinfo/networking/virtual-service-all-v1.yaml
</code></pre><p>Visit http://$GATEWAY_URL/productpage, and find that the reviews are fixed in the following version 1 page and no longer change.</p><p><img src=v1.png alt></p><h3 id=4-verify-mosn-s-capability-of-routing-by-weight>4. Verify MOSN&rsquo;s capability of routing by weight</h3><ul><li>Allocate 50% traffic respectively to v1 and v3</li></ul><pre><code class=language-bash>$ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-50-v3.yaml
</code></pre><p>Access http://$GATEWAY_URL/productpage, and find that the probability for v1 and v3 to appear respectively is <sup>1</sup>&frasl;<sub>2</sub>.</p><h3 id=5-verify-mosn-s-capability-of-routing-by-specific-header>5. Verify MOSN&rsquo;s capability of routing by specific header</h3><ul><li>There is a login entrance in the upper right corner of the BookInfo system. After you log in, the request carries the custom parameter <code>end-user</code> of which the value is user name. Mosn supports routing by the value of this header. For example, route the user Jason to the v2 while other users to v1 (both username and password are Jason, why this user can view the corresponding yaml file).</li></ul><pre><code class=language-bash>$ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-test-v2.yaml
</code></pre><p>When you access http://$GATEWAY_URL/productpage:</p><ul><li><p>Log in with the account of Jason and you will see the v2 interface.
<img src=login.png alt></p></li><li><p>Log in with the account of another user, you are always on v1 interface.
<img src=v1.png alt></p></li></ul></article></main></div><footer class=ss-footer><div class=container><div class=links><div class=cate><h2 class=cate-title>Resources</h2><a class=link href=https://github.com/dromara>Github</a>
<a class=link href=https://gitee.com/shuaiqiyu>Gitee</a></div><div class=cate><h2 class=cate-title>Get Involved</h2><a class=link href=https://github.com/dromara/soul/issues/new>Feedback</a>
<a class=link href=/community>Community</a>
<a class=link href=/blog>Blog</a></div><div class=cate><h2 class=cate-title>Document</h2><a class=link href=/projects/soul/overview/>Soul</a>
<a class=link href=/projects/hmily/overview/>Hmily</a>
<a class=link href=/projects/raincat/overview/>Raincat</a>
<a class=link href=/projects/myth/overview/>Myth</a></div></div><div class=qrcode><div><img class=qrcode-img src=/img/qrcode/qrcode_1.png><p class=qrcode-desc>Wechat Official Account</p></div><div><img class=qrcode-img src=/img/qrcode/qrcode_2.png><p class=qrcode-desc>QQ Group</p></div></div></div><div class=copyright><p>Copyright ©2021
<a href=/>xiaoyu@apache.org by xiaoyu</a></p></div></footer></body></html>