<!doctype html><html><head><title>SOFABoot Extension Point · dromara(Open source organization)</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="The girl on the prairie"><meta name=generator content="Hugo 0.55.5"><link rel="shortcut icon" href=/img/favicon.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="en"</script><script src=/js/app.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-187960192-2','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link href=/en/><img class=logo src=/img/logo.png></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/en/projects/><span>Projects</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/guides/><span>Guides</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/blog/><span>Blog</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/activities/><span>Activity</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/awesome/><span>Awesome Dromara</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/projects/sofa-boot/extension/><span>中文</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/en/projects/>Projects</a>
<a class=navbar-item href=/en/guides/>Guides</a>
<a class=navbar-item href=/en/blog/>Blog</a>
<a class=navbar-item href=/en/activities/>Activity</a>
<a class=navbar-item href=/awesome/>Awesome Dromara</a></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/projects/sofa-boot/extension/>中</a></div></div></div></nav></header><div class=ss-layout-container><aside class="ss-layout-aside -left ss-card -soft-hidden"></aside><main class="ss-layout-main -card"><div class=ss-meta><div class=container><h1 class=title>SOFABoot Extension Point</h1><a class="edit-button -hidden-mobile" href=https://github.com/dromara/edit/master/content/en/projects/sofa-boot/extension/index.md>Edit</a></div><div class=meta>Update time: 2021-01-24</div></div><article class=typo><p>SOFABoot supports modular isolation. But in actual usage scenarios, There is one case that beans in one module sometimes need to open some entries for another module to expand. SOFABoot draws on and uses the <a href=https://github.com/nuxeo-archives/nuxeo-runtime>Nuxeo Runtime</a> project and the <a href=https://github.com/nuxeo/nuxeo>nuxeo</a> project and expands on it, provides the ability to extend points with Spring, We call it <code>Extension Point</code>.</p><h2 id=usage>Usage</h2><p>Using extension point capabilities in SOFABoot requires the following three steps:</p><h3 id=define-a-bean-that-provides-extension-capabilities>Define a bean that provides extension capabilities</h3><p>When using the SOFABoot extension point capability, you first need to define an interface that needs to be extended, like:</p><pre><code class=language-java>package com.alipay.sofa.boot.test;

public interface IExtension {

    String say();
}
</code></pre><p>Define the implementation of this interface:</p><pre><code class=language-java>package com.alipay.sofa.boot.test.impl;

public class ExtensionImpl implements IExtension {

    private String word;

    @Override
    public String say() {
        return word;
    }

    public void setWord(String word) {
        this.word = word;
    }

    public void registerExtension(Extension extension) throws Exception {
        Object[] contributions = extension.getContributions();
        String extensionPoint = extension.getExtensionPoint();

        if (contributions == null) {
            return;
        }

        for (Object contribution : contributions) {
            if (&quot;word&quot;.equals(extensionPoint)) {
                setWord(((ExtensionDescriptor) contribution).getValue());
            }
        }
    }
}
</code></pre><p>Here you can see that there is a method: <code>registerExtension</code>, you can temporarily ignore this method, and later will introduce its specific role.</p><p>In the module&rsquo;s Spring configuration file, we add configuration of this bean:</p><pre><code class=language-xml>&lt;bean id=&quot;extension&quot; class=&quot;com.alipay.sofa.boot.test.impl.ExtensionImpl&quot;&gt;
    &lt;property name=&quot;word&quot; value=&quot;Hello, world&quot;/&gt;
&lt;/bean&gt;
</code></pre><h3 id=defining-extension-points>Defining extension points</h3><p>There is a field word in the above bean. In practice, we want this field to be overridden by other module customizations. Here we expose it as an extension point.</p><p>First, you need a class to describe this extension point:</p><pre><code class=language-java>@XObject(&quot;word&quot;)
public class ExtensionDescriptor {

    @XNode(&quot;value&quot;)
    private String value;

    public String getValue() {
        return value;
    }
}
</code></pre><p>Then define the extension point in xml:</p><pre><code class=language-xml>&lt;sofa:extension-point name=&quot;word&quot; ref=&quot;extension&quot;&gt;
    &lt;sofa:object class=&quot;com.alipay.sofa.boot.test.extension.ExtensionDescriptor&quot;/&gt;
&lt;/sofa:extension-point&gt;
</code></pre><p>among them:
- <code>name</code> is the name of the extension point
- <code>ref</code> is the bean to which the extension point is applied
- <code>object</code> is a concrete description of the contribution point of the extension point. This description is done by XMap (XMap is used to map Java objects and XML files. It is recommended to search XMap documents on the Internet to understand XMap)</p><h3 id=defining-extension-implements>Defining extension implements</h3><p>The above has defined the extension point, and we can extend this bean at this point:</p><pre><code class=language-xml>&lt;sofa:extension bean=&quot;extension&quot; point=&quot;word&quot;&gt;
    &lt;sofa:content&gt;
        &lt;word&gt;
            &lt;value&gt;newValue&lt;/value&gt;
        &lt;/word&gt;
    &lt;/sofa:content&gt;
&lt;/sofa:extension&gt;
</code></pre><p>among them:
- <code>bean</code> is the bean to which the extension is applied
- <code>point</code> is the name of the extension point
- The content inside <code>content</code> is an extension definition, which will parse the content through XMap into: the extension point&rsquo;s contribution point specific description object, here is the <code>com.alipay.sofa.boot.test.extension.ExtensionDescriptor</code> object</p><p>At this point, we can look back at the <code>registerExtension</code> method defined in <code>com.alipay.sofa.boot.test.impl.ExtensionImpl</code>. When SOFABoot resolves to the contribution point, it will call the <code>registerExtension of the extended bean. The</code> method contains the user-defined contribution point processing logic. In the above example, the user-defined value is obtained and set to the value in the word field that overrides the original definition in the bean.</p><p>At this point, call the <code>extension</code> bean&rsquo;s <code>say()</code> method, and you can see the value defined in the return extension: newValue.</p><h2 id=xmap-support-and-extension>XMap Support and Extension</h2><p>The above example is just a very simple extension. In fact, XMap contains a very rich description capability, including <code>List</code>, <code>Map</code>, etc. These can be seen by looking at the XMap documentation.</p><p>In SOFABoot, in addition to XMap native support, it extends the ability to integrate with Spring:
- Extend <code>XNodeSpring</code> via <code>XNode</code>
- Extend <code>XNodeListSpring</code> via <code>XNodeList</code>
- Extend <code>XNodeMapSpring</code> via <code>XNodeMap</code></p><p>This part of the expansion capabilities, the ability to extend the extension point, the description object can directly point to a SpringBean (user configuration bean name, SOFABoot will get the bean from the spring context according to the name), here is a use of <code>XNodeListSpring</code> The example is still the three steps described above:</p><h3 id=defining-a-bean-that-provides-extended-capabilities>Defining a bean that provides extended capabilities</h3><p>In this interface definition, we return a list, the goal is that this list can be filled by extension:</p><pre><code class=language-java>package com.alipay.sofa.boot.test;

public interface IExtension {

    List&lt;SimpleSpringListBean&gt; getSimpleSpringListBeans();
}
</code></pre><p>Where <code>SimpleSpringListBean</code> can be defined according to requirements, here we assume that an empty return is defined.</p><pre><code class=language-java>public class IExtensionImpl implements IExtension {
    private List&lt;SimpleSpringListBean&gt;       simpleSpringListBeans  = new ArrayList&lt;&gt;();

    @Override
    public List&lt;SimpleSpringListBean&gt; getSimpleSpringListBeans() {
        return simpleSpringListBeans;
    }
    
     public void registerExtension(Extension extension) throws Exception {
        Object[] contributions = extension.getContributions();
        String extensionPoint = extension.getExtensionPoint();

        if (contributions == null) {
            return;
        }

        for (Object contribution : contributions) {
            if (&quot;testSpringList&quot;.equals(extensionPoint)) {
                simpleSpringListBeans.addAll(((SpringListExtensionDescriptor) contribution)
                    .getValues());
            }
        }
    }
}
</code></pre><p>You can see that the bean defined by the extension point is added to the list in <code>registerExtension</code> to achieve the ability for the user to extend the list.</p><p>In the module&rsquo;s Spring configuration file, we configure this bean:</p><pre><code class=language-xml>    &lt;bean id=&quot;iExtension&quot; class=&quot;com.alipay.sofa.runtime.integration.extension.bean.IExtensionImpl&quot;/&gt;
</code></pre><h3 id=defining-extension-points-1>Defining extension points</h3><p>First, you need an object to describe:</p><pre><code class=language-java>@XObject(&quot;testSpringList&quot;)
public class SpringListExtensionDescriptor {

    @XNodeListSpring(value = &quot;value&quot;, componentType = SimpleSpringListBean.class, type = ArrayList.class)
    private List&lt;SimpleSpringListBean&gt; values;

    public List&lt;SimpleSpringListBean&gt; getValues() {
        return values;
    }
}
</code></pre><p>Here we use <code>@XNodeListSpring</code>. When the name of the corresponding bean is configured in XML, SOFABoot gets the corresponding bean instance from the spring context.</p><p>Define this extension point in XML</p><pre><code class=language-xml>&lt;sofa:extension-point name=&quot;testSpringList&quot; ref=&quot;iExtension&quot;&gt;
        &lt;sofa:object class=&quot;com.alipay.sofa.runtime.integration.extension.descriptor.SpringListExtensionDescriptor&quot;/&gt;
    &lt;/sofa:extension-point&gt;
</code></pre><h3 id=defining-extensions>Defining extensions</h3><pre><code class=language-xml>&lt;bean id=&quot;simpleSpringListBean1&quot; class=&quot;com.alipay.sofa.runtime.integration.extension.bean.SimpleSpringListBean&quot; /&gt;
&lt;bean id=&quot;simpleSpringListBean2&quot; class=&quot;com.alipay.sofa.runtime.integration.extension.bean.SimpleSpringListBean&quot; /&gt;

&lt;sofa:extension bean=&quot;iExtension&quot; point=&quot;testSpringList&quot;&gt;
    &lt;sofa:content&gt;
        &lt;testSpringList&gt;
            &lt;value&gt;simpleSpringListBean1&lt;/value&gt;
            &lt;value&gt;simpleSpringListBean2&lt;/value&gt;
        &lt;/testSpringList&gt;
    &lt;/sofa:content&gt;
&lt;/sofa:extension&gt;
</code></pre><p>When defining an extension, first define two beans and then put them into the extension definition.</p><p>At this point, call <code>iExtension.getSimpleSpringListBeans</code> method, you can see that it contains two beans added by the extension.</p><h2 id=defining-extension-points-and-extensions-by-client-mode>Defining extension points and extensions by client mode</h2><p>In addition to defining extension points and extensions through the above xml configuration, SOFABoot also provides <code>com.alipay.sofa.runtime.api.client.ExtensionClient</code> to define extension points and extensions.</p><h3 id=get-extensionclient>Get <code>ExtensionClient</code></h3><p>Getting <code>com.alipay.sofa.runtime.api.client.ExtensionClient</code> is relatively simple, and <code>com.alipay.sofa.runtime.api.aware.ExtensionClientAware</code> is provided in SOFABoot:</p><pre><code class=language-java>public class ExtensionClientBean implements ExtensionClientAware {
 
     private ExtensionClient extensionClient;
 
     @Override
     public void setExtensionClient(ExtensionClient extensionClient) {
         this.clientFactory = extensionClient;
     }
 
     public ExtensionClient getClientFactory() {
         return extensionClient;
     }
}
</code></pre><p>Define <code>ExtensionClientBean</code> as a Spring bean.</p><h3 id=定义扩展点>定义扩展点</h3><pre><code class=language-java>ExtensionPointParam extensionPointParam = new ExtensionPointParam();
extensionPointParam.setName(&quot;clientValue&quot;);
extensionPointParam.setTargetName(&quot;iExtension&quot;);
extensionPointParam.setTarget(iExtension);
extensionPointParam.setContributionClass(ClientExtensionDescriptor.class);
extensionClient.publishExtensionPoint(extensionPointParam);
</code></pre><p>The meaning of each parameter is consistent when the client and the extension point are registered via XML:
among them:
- <code>name</code> is the name of the extension point
- <code>targetName</code> is the name of the bean to which the extension point is applied
- <code>target</code> is the bean to which the extension point is applied
- <code>contributionClass</code> is a concrete description of the contribution points of the extension point. The definitions described here are as follows:</p><pre><code class=language-java>@XObject(&quot;clientValue&quot;)
public class ClientExtensionDescriptor {
    @XNode(&quot;value&quot;)
    private String value;

    public String getValue() {
        return value;
    }
}
</code></pre><p>Define extension points by <code>publishExtensionPoint</code> of <code>com.alipay.sofa.runtime.api.client.ExtensionClient</code></p><h3 id=defining-extension-implements-1>Defining extension implements</h3><pre><code class=language-java>DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();
DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();
Document doc = dBuilder.parse(new File(Thread.currentThread().getContextClassLoader()
    .getResource(&quot;META-INF/extension/extension.xml&quot;).toURI()));
ExtensionParam extensionParam = new ExtensionParam();
extensionParam.setTargetName(&quot;clientValue&quot;);
extensionParam.setTargetInstanceName(&quot;iExtension&quot;);
extensionParam.setElement(doc.getDocumentElement());
extensionClient.publishExtension(extensionParam);
</code></pre><p>The meaning of each parameter is consistent when the client and the extension point are registered via XML:
- <code>targetInstanceName</code> is the bean to which the extension is applied
- <code>targetName</code> is the name of the extension point
- The content inside the <code>element</code> is an extended definition. Here you need to pass in the <code>Element</code> object. By reading it from XML, the contents of the example are as follows:</p><pre><code class=language-xml>&lt;clientValue&gt;
    &lt;value&gt;SOFABoot Extension Client Test&lt;/value&gt;
&lt;/clientValue&gt;
</code></pre><p>The extension can be defined by <code>com.alipay.sofa.runtime.api.client.ExtensionClient.publishExtension()</code></p><h3 id=restrictions>Restrictions</h3><p>It can be seen that since the definition of the extension is strongly dependent on XML, although the extension point and extension are released through the client, the content of the extension itself needs XML to describe, and does not really use only the client. This part is welcome to contribute.</p></article></main></div><footer class=ss-footer><div class=container><div class=links><div class=cate><h2 class=cate-title>Resources</h2><a class=link href=https://github.com/dromara>Github</a>
<a class=link href=https://gitee.com/shuaiqiyu>Gitee</a></div><div class=cate><h2 class=cate-title>Get Involved</h2><a class=link href=https://github.com/dromara/soul/issues/new>Feedback</a>
<a class=link href=/community>Community</a>
<a class=link href=/blog>Blog</a></div><div class=cate><h2 class=cate-title>Document</h2><a class=link href=/projects/soul/overview/>Soul</a>
<a class=link href=/projects/hmily/overview/>Hmily</a>
<a class=link href=/projects/raincat/overview/>Raincat</a>
<a class=link href=/projects/myth/overview/>Myth</a></div></div><div class=qrcode><div><img class=qrcode-img src=/img/qrcode/qrcode_1.png><p class=qrcode-desc>Wechat Official Account</p></div><div><img class=qrcode-img src=/img/qrcode/qrcode_2.png><p class=qrcode-desc>QQ Group</p></div></div></div><div class=copyright><p>Copyright ©2021
<a href=/>xiaoyu@apache.org by xiaoyu</a></p></div></footer></body></html>