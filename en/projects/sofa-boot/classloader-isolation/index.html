<!doctype html><html><head><title>Use class isolation in SOFABoot · dromara(Open source organization)</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="The girl on the prairie"><meta name=generator content="Hugo 0.55.5"><link rel="shortcut icon" href=/img/favicon.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="en"</script><script src=/js/app.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-187960192-2','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link href=/en/><img class=logo src=/img/logo.png></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/en/projects/><span>Projects</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/guides/><span>Guides</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/blog/><span>Blog</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/activities/><span>Activity</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/awesome/><span>Awesome Dromara</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/projects/sofa-boot/classloader-isolation/><span>中文</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/en/projects/>Projects</a>
<a class=navbar-item href=/en/guides/>Guides</a>
<a class=navbar-item href=/en/blog/>Blog</a>
<a class=navbar-item href=/en/activities/>Activity</a>
<a class=navbar-item href=/awesome/>Awesome Dromara</a></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/projects/sofa-boot/classloader-isolation/>中</a></div></div></div></nav></header><div class=ss-layout-container><aside class="ss-layout-aside -left ss-card -soft-hidden"></aside><main class="ss-layout-main -card"><div class=ss-meta><div class=container><h1 class=title>Use class isolation in SOFABoot</h1><a class="edit-button -hidden-mobile" href=https://github.com/dromara/edit/master/content/en/projects/sofa-boot/classloader-isolation/index.md>Edit</a></div><div class=meta>Update time: 2021-01-24</div></div><article class=typo><p>SOFABoot provides a class isolation framework SOFAArk, giving Spring Boot a class isolation ability to resolve class or package conflicts in the development. For detailed information, please refer to:<a href=https://github.com/sofastack/sofa-ark>SOFAArk</a></p><p>To use this feature in SOFABoot projects, we need only two steps: configure the <code>sofa-ark-maven-plugin</code> plugins for packaging and add <code>sofa-ark-springboot-starter</code> dependencies of the class isolation framework.</p><h2 id=configure-maven-packaging-plugins>Configure Maven packaging plugins</h2><p>The <code>Maven</code> plugins - <code>sofa-ark-maven-plugin</code> are available on the Central Repository. Through simple configurations, a SpringBoot project can be wrapped into an executable Ark package in the standard format. The coordinate of <code>sofa-ark-maven-plugin</code> is:</p><pre><code class=language-xml>&lt;plugin&gt;
    &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt;
    &lt;artifactId&gt;sofa-ark-maven-plugin&lt;/artifactId&gt;
&lt;/plugin&gt;
</code></pre><p>The configuration template is described as follows:</p><pre><code class=language-xml>&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt;
            &lt;artifactId&gt;sofa-ark-maven-plugin&lt;/artifactId&gt;
            &lt;executions&gt;
                &lt;execution&gt;
                    &lt;id&gt;default-cli&lt;/id&gt;
                    
                    &lt;!--goal executed to generate executable-ark-jar --&gt;
                    &lt;goals&gt;
                        &lt;goal&gt;repackage&lt;/goal&gt;
                    &lt;/goals&gt;
                    
                    &lt;configuration&gt;
                        &lt;!--specify destination where executable-ark-jar will be saved, default saved to ${project.build.directory}--&gt;
                        &lt;outputDirectory&gt;./target&lt;/outputDirectory&gt;
                        
                        &lt;!--default none--&gt;
                        &lt;arkClassifier&gt;executable-ark&lt;/arkClassifier&gt;
                        
                        &lt;!-- all class exported by ark plugin would be resolved by ark biz in default, if 
                        configure denyImportClasses, then it would prefer to load them by ark biz itself --&gt;
                        &lt;denyImportClasses&gt;
                            &lt;class&gt;com.alipay.sofa.SampleClass1&lt;/class&gt;
                            &lt;class&gt;com.alipay.sofa.SampleClass2&lt;/class&gt;
                        &lt;/denyImportClasses&gt;
                        
                        &lt;!-- Corresponding to denyImportClasses, denyImportPackages is package-level --&gt;
                        &lt;denyImportPackages&gt;
                            &lt;package&gt;com.alipay.sofa&lt;/package&gt;
                            &lt;package&gt;org.springframework&lt;/package&gt;
                        &lt;/denyImportPackages&gt;
                        
                        &lt;!-- denyImportResources can prevent resource exported by ark plugin with accurate 
                        name to be resolved --&gt;
                        &lt;denyImportResources&gt;
                            &lt;resource&gt;META-INF/spring/test1.xml&lt;/resource&gt;
                            &lt;resource&gt;META-INF/spring/test2.xml&lt;/resource&gt;
                        &lt;/denyImportResources&gt;
                    &lt;/configuration&gt;
                &lt;/execution&gt;
            &lt;/executions&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;
</code></pre><p>Description of plugin configuration:</p><ul><li><code>outputDirectory</code>: Execute <code>mvn package</code> and then specify a directory to store the Ark package. The default directory is ${project. Build. Directory}.</li><li><code>arkClassifier</code>: Execute <code>mvn docleoy</code>, and then specify the coordinates of Maven repositories to locate the Ark package by setting the <code>classfaulter</code> value (the default is empty). We recommend that you configure this to give a different name from the ordinary Fat jar;</li><li><code>denyImportClasses</code>: By default, the application will first load the classes that the Art plugin exports. It can be configured to deny such export.</li><li><code>denyImportPackages</code>: Corresponding to the above <code>denyImportClasses</code>, it can be configured to deny import at the package level;</li><li><code>denyImportResources</code>: By default, the application will first load the resources that the Art plugin exports. It can be configured to deny such export.</li></ul><h2 id=add-dependencies-for-the-class-isolation-framework>Add dependencies for the class isolation framework</h2><p>To use SOFABoot class isolation capabilities when running test cases in the development process, we need to add the following dependencies into the SOFABoot project:</p><pre><code class=language-xml>&lt;dependency&gt;
    &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt;
    &lt;artifactId&gt;sofa-ark-springboot-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><p>In accordance with SpringBoot&rsquo;s dependency-as-a-service principle, after adding those dependencies, the SOFABoot class isolation container will be started before the application runs.</p><p>SOFABoot&rsquo;s class isolation framework will automatically check whether Ark plugins (or jars that need to be isolated; for detailed information, please refer to <a href=https://github.com/sofastack/sofa-Ark>SOFAArk</a>) has been loaded into the application, and isolated from loading; for example, to avoid dependency conflicts between the official SOFARPC components provided by SOFABoot and the application, SOFABoot provides an Ark plugin version of SOFARPC. If you want to isolate SOFARPC, you only need to add the following components:</p><pre><code class=language-xml>&lt;dependency&gt;
    &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt;
    &lt;artifactId&gt;rpc-sofa-boot-starter&lt;/artifactId&gt;
    &lt;classifier&gt;ark-plugin&lt;/classifier&gt;
&lt;/dependency&gt;
</code></pre><p>By doing so, SOFABoot&rsquo;s class isolation container will automatically isolate SOFARPC and other application dependencies at run time to avoid potential package conflicts. Developers, of course, can also develop their own Ark plugin packages (refer to <a href=https://github.com/sofastack/sofa-Ark>SOFAArk</a> for details).</p><h2 id=running>Running</h2><h3 id=running-in-ide>Running in IDE</h3><p>Simply run the <code>main</code> function. If successful, the following startup log will appear:</p><pre><code class=language-java>2018-04-07 10:51:59,646 INFO  main                             - Begin to start ArkServiceContainer
2018-04-07 10:52:00,550 INFO  main                             - Init Service: com.alipay.sofa.ark.container.service.plugin.PluginDeployServiceImpl
2018-04-07 10:52:00,551 INFO  main                             - Init Service: com.alipay.sofa.ark.container.service.classloader.ClassloaderServiceImpl
2018-04-07 10:52:00,557 INFO  main                             - Finish to start ArkServiceContainer
2018-04-07 10:52:00,571 INFO  main                             - Start to process pipeline stage: com.alipay.sofa.ark.container.pipeline.HandleArchiveStage
2018-04-07 10:52:00,624 INFO  main                             - Finish to process pipeline stage: com.alipay.sofa.ark.container.pipeline.HandleArchiveStage
2018-04-07 10:52:00,624 INFO  main                             - Start to process pipeline stage: com.alipay.sofa.ark.container.pipeline.DeployPluginStage
2018-04-07 10:52:00,626 INFO  main                             - Start to deploy plugin: sample-ark-plugin
starting in sample ark plugin activator
2018-04-07 10:52:00,645 INFO  main                             - Service: com.alipay.sofa.ark.sample.facade.SamplePluginService publish by: PluginServiceProvider{pluginName='sample-ark-plugin', priority=1000} succeed
2018-04-07 10:52:00,647 INFO  main                             - Finish to deploy plugin: sample-ark-plugin
2018-04-07 10:52:00,647 INFO  main                             - Finish to process pipeline stage: com.alipay.sofa.ark.container.pipeline.DeployPluginStage
2018-04-07 10:52:00,647 INFO  main                             - Start to process pipeline stage: com.alipay.sofa.ark.container.pipeline.DeployBizStage
2018-04-07 10:52:00,650 INFO  main                             - Begin to start biz: Startup In IDE
</code></pre><h3 id=packaging-to-run>Packaging to run</h3><p>Select <code>mvn clean install</code> to package the project into a fat jar with class isolation features. The packaged file format is like this:</p><pre><code>.
├── classes
│   └── com
│       └── alipay
│           └── sofa
│               └── boot
│                   └── examples
│                       └── demo
│                           └── isolation
│                               └── SofaBootClassIsolationDemoApplication.class
├── generated-sources
│   └── annotations
├── maven-archiver
│   └── pom.properties
├── maven-status
│   └── maven-compiler-plugin
│       ├── compile
│       │   └── default-compile
│       │       ├── createdFiles.lst
│       │       └── inputFiles.lst
│       └── testCompile
│           └── default-testCompile
│               └── inputFiles.lst
├── sofaboot-sample-with-isolation-2.4.0-ark-biz.jar
├── sofaboot-sample-with-isolation-2.4.0-executable-ark.jar
└── sofaboot-sample-with-isolation-2.4.0.jar
</code></pre><p>Here, <code>sofabot-sample-with-isolation-2.4.0-executable-ark</code> is a Fat Jar with the class isolation capability, so we can simply start it up with the <code>java -jar</code> command. Execute <code>java -jar sofaboot-sample-with-isolation-2.4.0-executable-ark</code> on the server or console, and a successful startup log will appear like this:</p><pre><code>2018-04-07 10:57:48.033  INFO 8488 --- [           main] s.b.c.e.t.TomcatEmbeddedServletContainer : Tomcat started on port(s): 8080 (http)
2018-04-07 10:57:48.042  INFO 8488 --- [           main] .i.SofaBootClassIsolationDemoApplication : Started SofaBootClassIsolationDemoApplication in 7.432 seconds (JVM running for 8.99)
Ark container started in 8797 ms.
</code></pre><h2 id=testing>Testing</h2><p>To run the test cases with SOFABoot&rsquo;s class isolation ability, you need to add an extra dependency—SOFABoot&rsquo;s official <code>test-sofa-boot-starter</code>—and write integration testing and unit testing code using <code>SofaBootRunner</code> and <code>SofaJUnit4Runner</code>, which is also a coding style for test cases recommended by SOFABoot.</p><p>With the two modules, the system can automatically check whether the application has used the class isolation capability. Developers can achieve this by simply adding or deleting the SOFABoot class isolation dependencies</p><pre><code class=language-xml>&lt;dependency&gt;
    &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt;
    &lt;artifactId&gt;sofa-ark-springboot-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><p>to complete the integration and separation of the SOFABoot class isolation. See the following for details:</p><h4 id=sofabootrunner>SofaBootRunner</h4><p>Sample code for integration testing:</p><pre><code class=language-java>@RunWith(SofaBootRunner.class)
@SpringBootTest(classes = SofaBootClassIsolationDemoApplication.class)
public class IntegrationTestCase {

    @Autowired
    private SampleService sampleService;

    @Test
    public void test() {
        Assert.assertTrue(&quot;service&quot;.equals(sampleService.service()));
    }

}
</code></pre><p>The <code>SofaBootRunner</code> will check whether the application has introduced dependencies;</p><pre><code class=language-xml>&lt;dependency&gt;
    &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt;
    &lt;artifactId&gt;sofa-ark-springboot-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><p>In accordance with Spring Boot&rsquo;s dependency-as-a-service principle, if the <code>sofa-Ark-springboot-starter</code> dependency is detected, then the <code>SofaBootRunner</code> will enable SOFABoot&rsquo;s class isolation capability, otherwise, it will be the same as the native <code>SpringRunner</code>.</p><h4 id=sofajunit4runner>SofaJUnit4Runner</h4><p>Sample code for unit testing:</p><pre><code class=language-java>@RunWith(SofaJUnit4Runner.class)
public class UnitTestCase {

    @Test
    public void test() {
        Assert.assertTrue(true);
    }
}
</code></pre><p>Likewise, <code>SofaJUnit4Runner</code> will check whether the dependency is introduced. If so, the <code>SofaJUnit4Runner</code> will enable the capability as well, or will be same as the native <code>JUnit4</code>.</p><h4 id=customized-runner>Customized Runner</h4><p>When writing test cases, sometimes we need to specify a special Runner. For a unified coding style, you can use <code>SofaBootRunner</code> and <code>SofaJUnit4Runner</code> with the annotation <code>@DelegateToRunner</code>. Here is some sample code:</p><pre><code class=language-java>@RunWith(SofaJUnit4Runner.class)
@DelegateToRunner(BlockJUnit4ClassRunner.class)
public class UnitTestCaseWithoutArk {

    @Test
    public void test() {
        Assert.assertFalse(true);
    }

}
</code></pre><p>It is identical to the following:</p><pre><code class=language-java>@RunWith(BlockJUnit4ClassRunner.class)
public class UnitTestCaseWithoutArk {

    @Test
    public void test() {
        Assert.assertFalse(true);
    }

}
</code></pre></article></main></div><footer class=ss-footer><div class=container><div class=links><div class=cate><h2 class=cate-title>Resources</h2><a class=link href=https://github.com/dromara>Github</a>
<a class=link href=https://gitee.com/shuaiqiyu>Gitee</a></div><div class=cate><h2 class=cate-title>Get Involved</h2><a class=link href=https://github.com/dromara/soul/issues/new>Feedback</a>
<a class=link href=/community>Community</a>
<a class=link href=/blog>Blog</a></div><div class=cate><h2 class=cate-title>Document</h2><a class=link href=/projects/soul/overview/>Soul</a>
<a class=link href=/projects/hmily/overview/>Hmily</a>
<a class=link href=/projects/raincat/overview/>Raincat</a>
<a class=link href=/projects/myth/overview/>Myth</a></div></div><div class=qrcode><div><img class=qrcode-img src=/img/qrcode/qrcode_1.png><p class=qrcode-desc>Wechat Official Account</p></div><div><img class=qrcode-img src=/img/qrcode/qrcode_2.png><p class=qrcode-desc>QQ Group</p></div></div></div><div class=copyright><p>Copyright ©2021
<a href=/>xiaoyu@apache.org by xiaoyu</a></p></div></footer></body></html>