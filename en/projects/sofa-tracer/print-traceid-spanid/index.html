<!doctype html><html><head><title>Print traceId and spanId in application log · dromara(Open source organization)</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="The girl on the prairie"><meta name=generator content="Hugo 0.55.5"><link rel="shortcut icon" href=/img/favicon.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="en"</script><script src=/js/app.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-187960192-2','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link href=/en/><img class=logo src=/img/logo.png></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/en/projects/><span>Projects</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/guides/><span>Guides</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/blog/><span>Blog</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/activities/><span>Activity</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/awesome/><span>Awesome Dromara</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/projects/sofa-tracer/print-traceid-spanid/><span>中文</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/en/projects/>Projects</a>
<a class=navbar-item href=/en/guides/>Guides</a>
<a class=navbar-item href=/en/blog/>Blog</a>
<a class=navbar-item href=/en/activities/>Activity</a>
<a class=navbar-item href=/awesome/>Awesome Dromara</a></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/projects/sofa-tracer/print-traceid-spanid/>中</a></div></div></div></nav></header><div class=ss-layout-container><aside class="ss-layout-aside -left ss-card -soft-hidden"></aside><main class="ss-layout-main -card"><div class=ss-meta><div class=container><h1 class=title>Print traceId and spanId in application log</h1><a class="edit-button -hidden-mobile" href=https://github.com/dromara/edit/master/content/en/projects/sofa-tracer/print-traceid-spanid/index.md>Edit</a></div><div class=meta>Update time: 2021-01-24</div></div><article class=typo><h1 id=print-traceid-and-spanid-to-application-log>Print traceId And spanId To Application Log</h1><p>SLF4J provides MDC (Mapped Diagnostic Contexts), which supports you to define and modify log output formats and content. This document introduces the SLF4J MDC feature integrated in SOFATracer, which allows you to output the current SOFATracer context <code>TraceId</code> and <code>SpanId</code> with simply modifying the log configuration file.</p><h2 id=prerequisites>Prerequisites</h2><p>In order to properly print the <code>TraceId</code> and <code>SpanId</code> parameters in the logs of the application, the log programming interface needs to be programmed for <a href=https://www.slf4j.org/manual.html><code>SLF4J</code></a>. That is, the programming interface for printing log does not rely on specific log implementation.</p><pre><code class=language-xml>&lt;dependency&gt;
    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
    &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><h2 id=introduce-dependency>Introduce dependency</h2><p>For SOFABoot or Spring Boot application, you need to introduce the specific log implementation. It is recommended to introduce Logback and Log4j2 instead of Log4j. Also, it is suggested to use only one log implementation rather than multiple implementations.</p><ul><li>Logback implementation:</li></ul><pre><code class=language-xml>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-logging&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><ul><li>Log4j2 implementation:</li></ul><pre><code class=language-xml>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-log4j2&lt;/artifactId&gt;
    &lt;!--SOFABoot does not control log4j2 version --&gt;
    &lt;version&gt;1.4.2.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><h2 id=configuration-method>Configuration method</h2><p>The corresponding TraceId and SpanId are printed based on <a href=https://www.slf4j.org/manual.html>SLF4J MDC</a>. First, the log programming interface in application should be oriented to <code>SLF4J</code>, as follows:</p><pre><code class=language-java>/ / Introduce interface
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
    
/ / Construct log printing instance
private static final Logger logger = LoggerFactory.getLogger(XXX.class);
</code></pre><p>Second, to correctly print the <code>TraceId</code> and <code>SpanId</code> parameters, we also need to configure the extra parameters of <code>PatternLayout</code> in the log configuration file. The two parameters are <code>%X{SOFA-TraceId}</code> and <code>%X. {SOFA-SpanId}</code>, whose values ​​can be obtained from MDC.</p><p><a href=https://logback.qos.ch/><code>pattern</code> parameter configured with <code>Logback</code> as an example</a>:</p><pre><code class=language-xml>&lt;pattern&gt;%d{yyyy-MM-dd HH:mm:ss.SSS} %5p  [%X{SOFA-TraceId},
%X{SOFA-SpanId}] 
---- %m%n&lt;/pattern&gt;
</code></pre><ul><li>Key configuration items: As a part of the <code>Logback pattern</code>, <code>[%X{SOFA-TraceId},%X{SOFA-SpanId}]</code> replaces the placeholders in the pattern with the specific TraceId and SpanId in the current thread process when the corresponding <code>appender</code> is called. If there is no corresponding TraceId and SpanId in the current thread, the placeholder is replaced with &ldquo;null&rdquo;.</li></ul><p><a href=https://logging.apache.org/log4j/2.0/manual/layouts.html>Log4j2 PatternLayout configuration sample</a>:</p><pre><code class=language-xml>&lt;PatternLayout pattern=&quot;%d{yyyy-MM-dd HH:mm:ss.SSS} %5p 
[%X{SOFA-TraceId},%X{SOFA-SpanId}] ---- %m%n &quot; /&gt;
</code></pre><p><a href=https://logging.apache.org/log4j/1.2/apidocs/org/apache/log4j/PatternLayout.html>Log4j PatternLayout configuration sample</a>:</p><pre><code class=language-xml> &lt;layout class=&quot;org.apache.log4j.PatternLayout&quot;&gt;
     &lt;param name=&quot;ConversionPattern&quot; value=&quot;%d %-5p %-32t 
     [%X{SOFA-TraceId},%X{SOFA-SpanId}] - %m%n&quot;/&gt;
 &lt;/layout&gt;
</code></pre><blockquote><p>Note: <code>[%X{SOFA-TraceId},%X{SOFA-SpanId}]</code> is the recommended printing format, which can be customized based on your actual scenario requirements.</p></blockquote></article></main></div><footer class=ss-footer><div class=container><div class=links><div class=cate><h2 class=cate-title>Resources</h2><a class=link href=https://github.com/dromara>Github</a>
<a class=link href=https://gitee.com/shuaiqiyu>Gitee</a></div><div class=cate><h2 class=cate-title>Get Involved</h2><a class=link href=https://github.com/dromara/soul/issues/new>Feedback</a>
<a class=link href=/community>Community</a>
<a class=link href=/blog>Blog</a></div><div class=cate><h2 class=cate-title>Document</h2><a class=link href=/projects/soul/overview/>Soul</a>
<a class=link href=/projects/hmily/overview/>Hmily</a>
<a class=link href=/projects/raincat/overview/>Raincat</a>
<a class=link href=/projects/myth/overview/>Myth</a></div></div><div class=qrcode><div><img class=qrcode-img src=/img/qrcode/qrcode_1.png><p class=qrcode-desc>Wechat Official Account</p></div><div><img class=qrcode-img src=/img/qrcode/qrcode_2.png><p class=qrcode-desc>QQ Group</p></div></div></div><div class=copyright><p>Copyright ©2021
<a href=/>xiaoyu@apache.org by xiaoyu</a></p></div></footer></body></html>