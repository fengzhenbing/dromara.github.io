<!doctype html><html><head><title>DataSource Integration · dromara(Open source organization)</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="The girl on the prairie"><meta name=generator content="Hugo 0.55.5"><link rel="shortcut icon" href=/img/favicon.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="en"</script><script src=/js/app.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-187960192-2','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link href=/en/><img class=logo src=/img/logo.png></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/en/projects/><span>Projects</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/guides/><span>Guides</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/blog/><span>Blog</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/activities/><span>Activity</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/awesome/><span>Awesome Dromara</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/projects/sofa-tracer/usage-of-datasource/><span>中文</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/en/projects/>Projects</a>
<a class=navbar-item href=/en/guides/>Guides</a>
<a class=navbar-item href=/en/blog/>Blog</a>
<a class=navbar-item href=/en/activities/>Activity</a>
<a class=navbar-item href=/awesome/>Awesome Dromara</a></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=Search><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/projects/sofa-tracer/usage-of-datasource/>中</a></div></div></div></nav></header><div class=ss-layout-container><aside class="ss-layout-aside -left ss-card -soft-hidden"></aside><main class="ss-layout-main -card"><div class=ss-meta><div class=container><h1 class=title>DataSource Integration</h1><a class="edit-button -hidden-mobile" href=https://github.com/dromara/edit/master/content/en/projects/sofa-tracer/usage-of-datasource/index.md>Edit</a></div><div class=meta>Update time: 2021-01-24</div></div><article class=typo><p>In this document will demonstrate how to use SOFATracer to track of Datasource.</p><p>Assuming you have built a simple Spring Web project based on SOFABoot, Then you can be operated by the following steps:</p><h2 id=introduce-sofatracer>Introduce SOFATracer</h2><p>Introduce SOFATracer dependency in the new Spring Boot project:</p><pre><code class=language-xml>&lt;dependency&gt;
    &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt;
    &lt;artifactId&gt;tracer-sofa-boot-starter&lt;/artifactId&gt;
    &lt;version&gt;2.2.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><h2 id=introduce-h2database-dependencies>Introduce h2database dependencies</h2><p>For convenience, we use the h2database memory database for test. So, we need to introduce the following dependencies:</p><pre><code class=language-xml>&lt;dependency&gt;
    &lt;groupId&gt;com.h2database&lt;/groupId&gt;
    &lt;artifactId&gt;h2&lt;/artifactId&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;mysql&lt;/groupId&gt;
    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><h2 id=introduce-the-required-connection-pool-dependencies>Introduce the required connection pool dependencies</h2><p>Introduce the required connection pool dependency packages, such as druid, c3p0, tomcat, dbcp, Hikari, and so on.</p><pre><code class=language-xml>&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
    &lt;artifactId&gt;druid&lt;/artifactId&gt;
    &lt;version&gt;1.0.12&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;c3p0&lt;/groupId&gt;
    &lt;artifactId&gt;c3p0&lt;/artifactId&gt;
    &lt;version&gt;0.9.1.1&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;
    &lt;artifactId&gt;tomcat-jdbc&lt;/artifactId&gt;
    &lt;version&gt;8.5.31&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;commons-dbcp&lt;/groupId&gt;
    &lt;artifactId&gt;commons-dbcp&lt;/artifactId&gt;
    &lt;version&gt;1.4&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.zaxxer&lt;/groupId&gt;
    &lt;artifactId&gt;HikariCP-java6&lt;/artifactId&gt;
    &lt;version&gt;2.3.8&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><h2 id=configure-data-source>Configure data source</h2><p>Taking <code>HikariCP</code> as the example, we create a new Spring configuration file named <code>datasource.xml</code>, which defines the followings:</p><pre><code class=language-xml>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;
    &lt;!-- dataSource pool --&gt;
    &lt;bean id=&quot;simpleDataSource&quot; class=&quot;com.zaxxer.hikari.HikariDataSource&quot; destroy-method=&quot;close&quot; primary=&quot;true&quot;&gt;
        &lt;property name=&quot;driverClassName&quot; value=&quot;org.h2.Driver&quot;/&gt;
        &lt;property name=&quot;jdbcUrl&quot; value=&quot;jdbc:h2:~/test&quot;/&gt;
        &lt;property name=&quot;username&quot; value=&quot;sofa&quot;/&gt;
        &lt;property name=&quot;password&quot; value=&quot;123456&quot;/&gt;
    &lt;/bean&gt;
&lt;/beans&gt;
</code></pre><h2 id=application-configuration>Application configuration</h2><ul><li>Required configuration</li></ul><p>It should be noted that it is required to configure the application name when introducing SOFATracer; otherwise, the application may fails to start. This property is consistent with the SOFABoot framework requirements and is configured as follows:</p><pre><code class=language-properties>spring.application.name=SOFATracerDataSource
</code></pre><ul><li>Optional configuration</li></ul><p>In order to run the sample project normally, you need to configure the h2database properties. Also for easy viewing of logs, configure the log path as follows:</p><pre><code class=language-properties># logging path
logging.path=./logs

# h2 web consloe path
spring.h2.console.path=/h2-console
#enable h2 web consloe, which defaults to false
spring.h2.console.enabled=true
#Allow remote access to h2 web consloe
spring.h2.console.settings.web-allow-others=true

spring.datasource.username=sofa
spring.datasource.password=123456
spring.datasource.url=jdbc:h2:~/test
spring.datasource.driver-class-name=org.h2.Driver
</code></pre><h2 id=create-a-new-rest-service>Create a new Rest Service</h2><p>In order to achieve the demo effect, we create a new Rest service and trigger SQL statement execution to view the tracer records of sql. The Rest service is created as follows:</p><pre><code class=language-java>@RestController
public class SimpleRestController {

    @Autowired
    private DataSource simpleDataSource;

    @RequestMapping(&quot;/create&quot;)
    public Map&lt;String, Object&gt; create() {
        Map&lt;String, Object&gt; resultMap = new HashMap&lt;String, Object&gt;();
        try {
            Connection cn = simpleDataSource.getConnection();
            Statement st = cn.createStatement();
            st.execute(&quot;DROP TABLE IF EXISTS TEST;&quot;
                    + &quot;CREATE TABLE TEST(ID INT PRIMARY KEY, NAME VARCHAR(255));&quot;);
            resultMap.put(&quot;success&quot;, true);
            resultMap.put(&quot;result&quot;, &quot;CREATE TABLE TEST(ID INT PRIMARY KEY, NAME VARCHAR(255))&quot;);
        } catch (Throwable throwable) {
            resultMap.put(&quot;success&quot;, false);
            resultMap.put(&quot;error&quot;, throwable.getMessage());
        }
        return resultMap;
    }

}
</code></pre><p>You can see that the Rest service has created a table.</p><h2 id=demonstration>Demonstration</h2><p>Start the application and visit <code>localhost:8080/create</code> to execute the above Rest service. You can see the Tracer log of sql execution in <code>./logs/datasource-client-digest.log</code> and <code>./logs/datasource-client-stat.log</code>:
+ datasource-client-digest.log</p><pre><code class=language-json>{&quot;time&quot;:&quot;2018-09-05 11:48:16.917&quot;,&quot;local.app&quot;:&quot;SOFATracerDataSource&quot;,&quot;traceId&quot;:&quot;1e323a031536119296795100182779&quot;,&quot;spanId&quot;:&quot;0.1.2&quot;,&quot;database.name&quot;:&quot;test&quot;,&quot;sql&quot;:&quot;DROP TABLE IF EXISTS TEST;CREATE TABLE TEST(ID INT PRIMARY KEY%2C NAME VARCHAR(255));&quot;,&quot;result.code&quot;:&quot;success&quot;,&quot;total.time&quot;:&quot;103ms&quot;,&quot;connection.establish.span&quot;:&quot;92ms&quot;,&quot;db.execute.cost&quot;:&quot;8ms&quot;,&quot;database.type&quot;:&quot;h2&quot;,&quot;database.endpoint&quot;:&quot;jdbc:h2:~/test:-1&quot;,&quot;current.thread.name&quot;:&quot;http-nio-8080-exec-1&quot;,&quot;baggage&quot;:&quot;&quot;}
</code></pre><ul><li>datasource-client-stat.log (print once in 60s by default)</li></ul><pre><code class=language-json>{&quot;time&quot;:&quot;2018-09-05 11:49:10.117&quot;,&quot;stat.key&quot;:{&quot;local.app&quot;:&quot;SOFATracerDataSource&quot;,&quot;database.name&quot;:&quot;test&quot;},&quot;count&quot;:1,&quot;total.cost.milliseconds&quot;:103,&quot;success&quot;:&quot;true&quot;,&quot;load.test&quot;:&quot;F&quot;}
</code></pre><h2 id=other>Other</h2><p>Introduce the SOFATracer dependency in the Spring Boot project, which will automatically enable the DataSource events. You can disable starting DataSource by configuring the following switch, which is turned on by default:</p><pre><code class=language-properties>com.alipay.sofa.tracer.datasource.enable=false
</code></pre><h2 id=notes>Notes</h2><ul><li>To introduce SOFATracer, it is required to configure the application name; otherwise, the application fails to be started. The property name is: <code>spring.application.name</code>.</li><li>Based on the standard JDBC interface implementation, SOFATracer 2.2.0 theoretically supports event tracking for all standard database connection pools (such as DBCP, BoneCP, etc.). In Spring Boot environment, automatic event tracking is available for the five connection pools, namely DBCP, Druid, c3p0, tomcat, and HikariCP. It means that you only need to introduce SOFATracer dependency. In non-Spring Boot environment or for other connection pools (such as BoneCP), you need to configure them manually, for example:</li></ul><pre><code class=language-xml>&lt;bean id=&quot;smartDataSource&quot; class=&quot;com.alipay.sofa.tracer.plugins.datasource.SmartDataSource&quot; init-method=&quot;init&quot;&gt;
    &lt;property name=&quot;delegate&quot; ref=&quot;simpleDataSource&quot;/&gt;
    &lt;!--application name--&gt;
    &lt;property name=&quot;appName&quot; value=&quot;yourAppName&quot;/&gt;
    &lt;!--database name --&gt;
    &lt;property name=&quot;database&quot; value=&quot;yourDatabase&quot;/&gt;
    &lt;!--database type, supporting MYSQL, ORACLE--&gt;
    &lt;property name=&quot;dbType&quot; value=&quot;MYSQL&quot;/&gt;
&lt;/bean&gt;

&lt;bean id=&quot;simpleDataSource&quot; class=&quot;com.jolbox.bonecp.BoneCPDataSource&quot; destroy-method=&quot;close&quot;&gt;
    &lt;property name=&quot;driverClass&quot; value=&quot;com.mysql.jdbc.Driver&quot; /&gt;
    &lt;property name=&quot;jdbcUrl&quot; value=&quot;jdbc:mysql://127.0.0.1/yourdb&quot; /&gt;
    &lt;property name=&quot;username&quot; value=&quot;root&quot;/&gt;
    &lt;property name=&quot;password&quot; value=&quot;abcdefgh&quot;/&gt;
    ...
&lt;/bean&gt;
</code></pre><p>That is, you need to configure the <code>com.alipay.sofa.tracer.plugins.datasource.SmartDataSource</code> provided by SOFATracer.</p></article></main></div><footer class=ss-footer><div class=container><div class=links><div class=cate><h2 class=cate-title>Resources</h2><a class=link href=https://github.com/dromara>Github</a>
<a class=link href=https://gitee.com/shuaiqiyu>Gitee</a></div><div class=cate><h2 class=cate-title>Get Involved</h2><a class=link href=https://github.com/dromara/soul/issues/new>Feedback</a>
<a class=link href=/community>Community</a>
<a class=link href=/blog>Blog</a></div><div class=cate><h2 class=cate-title>Document</h2><a class=link href=/projects/soul/overview/>Soul</a>
<a class=link href=/projects/hmily/overview/>Hmily</a>
<a class=link href=/projects/raincat/overview/>Raincat</a>
<a class=link href=/projects/myth/overview/>Myth</a></div></div><div class=qrcode><div><img class=qrcode-img src=/img/qrcode/qrcode_1.png><p class=qrcode-desc>Wechat Official Account</p></div><div><img class=qrcode-img src=/img/qrcode/qrcode_2.png><p class=qrcode-desc>QQ Group</p></div></div></div><div class=copyright><p>Copyright ©2021
<a href=/>xiaoyu@apache.org by xiaoyu</a></p></div></footer></body></html>