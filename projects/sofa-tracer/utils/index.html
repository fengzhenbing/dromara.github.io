<!doctype html><html><head><title>SOFATracer 工具类 · dromara(Open source organization)</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="The girl on the prairie"><meta name=generator content="Hugo 0.55.5"><link rel="shortcut icon" href=/img/favicon.png type=image/png><link href=https://unpkg.com/purecss@1.0.0/build/base-min.css rel=stylesheet><link href=/css/main.css rel=stylesheet><link href=/css/zoom-image.css rel=stylesheet><script src=/js/iconfont.js></script><script src=/js/highlight.pack.js></script><script>hljs.initHighlightingOnLoad();</script><script>window.SITE_LANGUAGE="zh"</script><script src=/js/app.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-187960192-2','auto');ga('send','pageview');}</script></head><body><header class=ss-header><nav class=navbar role=navigation aria-label="main navigation"><div class=navbar-brand><a class=logo-link href=/><img class=logo src=/img/logo.png></a><div class=-show-mobile><a id=mobile-menu-icon><svg class="icon" aria-hidden="true"><use xlink:href="#icon-menu"/></svg></a><nav id=mobile-menu><div id=js-menu-search-mobile class=navbar-search-mobile><input class=input placeholder=请输入要搜索的关键词><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div><a href=/projects/><span>项目</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/guides/><span>指南</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/blog/><span>博客</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/activities/><span>活动</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/community/><span>社区</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/awesome/><span>Awesome Dromara</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-ARROW"/></svg></a>
<a href=/en/projects/sofa-tracer/utils/><span>English</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-transfer"/></svg></a></nav></div></div><div class="navbar-menu -hidden-mobile"><div class=navbar-start><a class=navbar-item href=/projects/>项目</a>
<a class=navbar-item href=/guides/>指南</a>
<a class=navbar-item href=/blog/>博客</a>
<a class=navbar-item href=/activities/>活动</a>
<a class=navbar-item href=/community/>社区</a>
<a class=navbar-item href=/awesome/>Awesome Dromara</a></div><div class=navbar-end><div class=navbar-item><div id=js-menu-search class=navbar-search><input class=input placeholder=请输入要搜索的关键词><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search"/></svg></div></div><div class=navbar-item><a class=translation href=/en/projects/sofa-tracer/utils/>En</a></div></div></div></nav></header><div class=ss-layout-container><aside class="ss-layout-aside -left ss-card -soft-hidden"></aside><main class="ss-layout-main -card"><div class=ss-meta><div class=container><h1 class=title>SOFATracer 工具类</h1><a class="edit-button -hidden-mobile" href=https://github.com/dromara/edit/master/content/zh/projects/sofa-tracer/utils/index.md>编辑</a></div><div class=meta>更新时间: 2021-01-24</div></div><article class=typo><h2 id=通过-sofatracer-上下文获取-span>通过 SOFATracer 上下文获取 Span</h2><p>在一次分布式链路调用过程中，在集成了 SOFATracer 的组件会产生一个 Span 并会缓存到 SOFATracer 的上下文中，这个上下文是缓存在 ThreadLocal 中的，作为使用者可以通过如下的方式随时获取到当前 SOFATracer 的上下文：</p><pre><code class=language-java>SofaTraceContext sofaTraceContext = SofaTraceContextHolder.getSofaTraceContext();
</code></pre><p>SOFATracer 上下文 <code>SofaTraceContext</code> 通过这个实例，可以对其缓存的 Span 执行增、删、改、查和清空操作。作为组件集成的同学在集成过程中我们会对 SOFATracer 上下文做增、删、改和查等操作来集成分布式链路跟踪的能力；但是作为直接使用 SOFATracer 的应用开发者，我们只需要能够获取相应的 Span 即可，即只需要在获取上下文后使用如下的方法：</p><pre><code>SofaTracerSpan sofaTracerSpan = sofaTraceContext.getCurrentSpan();
</code></pre><h2 id=通过-span-获取信息>通过 Span 获取信息</h2><p>在使用相应的组件如 Spring MVC 时，该组件集成了 SOFATracer 的能力后可以在获取到 Span 后获取到 Span 中的所有信息，具体获取方式示例（前提 Span 不为空即相应组件已经集成 SOFATracer）：</p><h3 id=获取-traceid-和-spanid>获取 TraceId 和 SpanId ：</h3><pre><code class=language-java>SofaTracerSpanContext sofaTracerSpanContext = currentSpan.getSofaTracerSpanContext();
String traceId = sofaTracerSpanContext.getTraceId();
String spanId = sofaTracerSpanContext.getSpanId();
</code></pre><h3 id=获取-opentracing-规范中的-tags-和-logs>获取 OpenTracing 规范中的 <code>Tags</code> 和 <code>Logs</code></h3><p>获取 <code>Tags</code>:</p><pre><code class=language-java>Map&lt;String, String&gt;    tagsStr = sofaTracerSpan.getTagsWithStr();
Map&lt;String, Boolean&gt;  tagsBool = sofaTracerSpan.getTagsWithBool();
Map&lt;String, Number&gt; tagsNumber = sofaTracerSpan.getTagsWithNumber();
</code></pre><p>获取 <code>Logs</code>:</p><pre><code class=language-java>List&lt;LogData&gt; logDataList = sofaTracerSpan.getLogs();
</code></pre><h2 id=透传数据处理>透传数据处理</h2><p>Baggage 元素是一个键值对集合，其携带的是需要透传的数据。SOFATracer 中将 Baggage 数据分为 sysBaggage 和 bizBaggage；sysBaggage 主要是指系统维度的透传数据，bizBaggage 主要是指业务的透传数据。</p><h3 id=设置和获取-baggageitem>设置和获取 BaggageItem</h3><p>BaggageItem 是 Baggage集合中的数据元素。</p><p>1、通过标准接口设置相应的 BaggageItem 数据：</p><pre><code class=language-java>String baggageKey = &quot;key&quot;;
String baggageVal = &quot;val&quot;;
sofaTracerSpan.setBaggageItem(baggageKey,baggageVal);
</code></pre><p>2、通过标准接口获取相应的 BaggageItem 数据：</p><pre><code class=language-java>String baggageKey = &quot;key&quot;;
String baggageValue = sofaTracerSpan.getBaggageItem(baggageKey);
</code></pre><p>注：当通过标准接口进行设置和获取 Baggage 数据时，实际上操作的对象均为 bizBaggage</p><h3 id=设置和获取-baggage-数据>设置和获取 &lsquo;Baggage&rsquo; 数据</h3><p>1、设置 &lsquo;Baggage&rsquo; 数据</p><pre><code class=language-java>SofaTracerSpanContext sofaTracerSpanContext = sofaTracerSpan.getSofaTracerSpanContext();

Map&lt;String, String&gt; bizBaggage = new HashMap&lt;String, String&gt;();
bizBaggage.put(&quot;bizKey&quot;,&quot;bizVal&quot;);
sofaTracerSpanContext.addBizBaggage(bizBaggage);

Map&lt;String, String&gt; sysBaggage = new HashMap&lt;String, String&gt;();
sysBaggage.put(&quot;sysKey&quot;,&quot;sysVal&quot;);
sofaTracerSpanContext.addSysBaggage(sysBaggage);
</code></pre><p>2、获取 &lsquo;Baggage&rsquo; 数据</p><pre><code class=language-java>SofaTracerSpanContext sofaTracerSpanContext = sofaTracerSpan.getSofaTracerSpanContext();
//获取 bizBaggage
Map&lt;String, String&gt; bizBaggages = sofaTracerSpanContext.getBizBaggage();
//获取 sysBaggage
Map&lt;String, String&gt; sysBaggages = sofaTracerSpanContext.getSysBaggage();
</code></pre><h3 id=遍历-baggage-数据>遍历 Baggage 数据</h3><p>OpenTracing 规范中 SpanContext 接口提供了 baggageItems() 方法，可以通过这个方法来遍历所有的 baggage 元素。SOFATracer 在 SofaTracerSpanContext 类中对 baggageItems() 方法进行了具体实现。</p><pre><code class=language-java>Iterable&lt;Map.Entry&lt;String, String&gt;&gt; entrySet = sofaTracerSpanContext.baggageItems();
</code></pre><p>注：遍历 Baggage 数据返回的是 sysBaggage 和 bizBaggage 的合集。</p></article></main></div><footer class=ss-footer><div class=container><div class=links><div class=cate><h2 class=cate-title>资源</h2><a class=link href=https://github.com/dromara>Github</a>
<a class=link href=https://gitee.com/shuaiqiyu>Gitee</a></div><div class=cate><h2 class=cate-title>参与进来</h2><a class=link href=https://github.com/dromara/soul/issues/new>反馈</a>
<a class=link href=/community>社区</a>
<a class=link href=/blog>博客</a></div><div class=cate><h2 class=cate-title>文档</h2><a class=link href=/projects/soul/overview/>Soul</a>
<a class=link href=/projects/hmily/overview/>Hmily</a>
<a class=link href=/projects/raincat/overview/>Raincat</a>
<a class=link href=/projects/myth/overview/>Myth</a></div></div><div class=qrcode><div><img class=qrcode-img src=/img/qrcode/qrcode_1.png><p class=qrcode-desc>微信公众号</p></div><div><img class=qrcode-img src=/img/qrcode/qrcode_2.png><p class=qrcode-desc>QQ群</p></div></div></div><div class=copyright><p>Copyright ©2021
<a href=/>xiaoyu@apache.org by xiaoyu</a></p></div></footer></body></html>